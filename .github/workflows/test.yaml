name: Release Workflow

on:
    workflow_dispatch:
        inputs:
            apiName:
              description: 'Select API'
              required: true
              default: 'fastapi-httpbin'
              type: choice
              options:
              - fastapi-httpbin
            tag:
              description: 'Version Tag'
              required: true
              type: string
    repository_dispatch:
        types: [trigger]

jobs:
    log-the-inputs:
        runs-on: ubuntu-latest
        steps:
          - 
            env:
              APINAME: ${{ inputs.apiName }}
              TAG: ${{ inputs.tag }}
            run: |
              echo "API Name: $APINAME"
              echo "Tag: $TAG"

    build:
        runs-on: ubuntu-latest
        steps:
        - 
            name: Setup Host Environment
            run: |
                sudo echo "${{ secrets.TYK_DASHBOARD_URL }} tyk-dashboard.org" | sudo tee -a /etc/hosts 
        -
            name: Setup ORAS
            uses: oras-project/setup-oras@v1
        -
            name: Download OpenAPI documenet
            run: oras pull registry-1.docker.io/${{ secrets.DOCKERHUB_USERNAME }}/apis:fastapi-httpbin-${{ inputs.tag }}
        -
            name: Convert to Tyk OAS API Definition
            run: |
                #!/bin/bash
                body=$(<openapi_schema.json)
                wget --method=POST http://tyk-dashboard.org/api/apis/oas/import --header='Authorization: ${{ secrets.TYK_APIKEY }}' --header='Content-Type: text/plain' --body-data="$body" -O res.json
                api_id=$(cat res.json | jq -r '.ID')

                echo "# "
                echo "# Temporary API ID $api_id ..."
                echo "# "

                echo "# "
                echo "# Retrieve API Definition JSON..."
                echo "# "
                wget --method=GET http://tyk-dashboard.org/api/apis/oas/$api_id --header 'Authorization: ${{ secrets.TYK_APIKEY }}' --header 'Content-Type: text/plain' -O res.json

                cat res.json | jq '.' > ${{ inputs.apiName }}.json

                echo "# "
                echo "# Remove Temporary API $api_id ..."
                echo "# "
                wget --method=DELETE http://tyk-dashboard.org/api/apis/oas/$api_id --header 'Authorization: ${{ secrets.TYK_APIKEY }}' -O res.json

                rm res.json

                echo "# "
                echo "# Generated API Definition ... ${{ env.APINAME }}.json "
                echo "# "
                cat ${{ env.APINAME }}.json